<!DOCTYPE html>
<html lang="fr">
  
<!-- Mirrored from upload-helper.n0flow.io/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 17 Feb 2026 10:08:25 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <base href="/lacale-helper-v2/">
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>La Cale - Upload Helper</title>
    <script>
      (() => {
        document.addEventListener(
          'click',
          (event) => {
            const anchor = event.target.closest('a[href="/"]');
            if (!anchor) return;

            event.preventDefault();
            const baseValue = document.querySelector('base')?.getAttribute('href') || './';
            window.location.assign(new URL('./', baseValue).toString());
          },
          true
        );
      })();
    </script>
    <style>
      .api-panel {
        margin: 16px;
        padding: 16px;
        border: 1px solid #334155;
        border-radius: 12px;
        background: #0f172a;
        color: #e2e8f0;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }
      .api-drop {
        margin-top: 8px;
        border: 1px dashed #475569;
        border-radius: 10px;
        padding: 14px;
        cursor: pointer;
      }
      .api-result {
        margin-top: 12px;
        white-space: pre-wrap;
        max-height: 280px;
        overflow: auto;
        background: #020617;
        border: 1px solid #1e293b;
        border-radius: 8px;
        padding: 10px;
        font-size: 12px;
      }
      .api-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .api-btn {
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid #334155;
        background: #111827;
        color: #e2e8f0;
        cursor: pointer;
      }
      .api-status { margin-top: 8px; font-size: 13px; color: #93c5fd; }
    </style>
    <script>
      (() => {
        const __LC_NAS_MODE_SIGNATURE = 'LC_NAS_API_MODE_V2';
        const API_HEALTH_URL = '/api/health';
        const API_ANALYZE_URL = '/api/analyze';
        const ALLOWED = ['.mkv', '.mp4', '.avi'];
        let nasModeEnabled = false;

        const ext = (name) => {
          const i = name.lastIndexOf('.');
          return i >= 0 ? name.slice(i).toLowerCase() : '';
        };

        const buildMinimalNfo = (mediaInfoJson) => {
          const tracks = mediaInfoJson?.media?.track || [];
          const get = (type, key) => {
            const t = tracks.find((x) => String(x['@type'] || '').toLowerCase() === type);
            return t ? (t[key] || '') : '';
          };
          return [
            'General',
            `Format                                   : ${get('general', 'Format')}`,
            `File size                                : ${get('general', 'FileSize_String') || get('general', 'FileSize')}`,
            '',
            'Video',
            `Format                                   : ${get('video', 'Format')}`,
            `Width                                    : ${get('video', 'Width_String') || get('video', 'Width')}`,
            `Height                                   : ${get('video', 'Height_String') || get('video', 'Height')}`,
            '',
            'Audio',
            `Format                                   : ${get('audio', 'Format')}`,
            `Language                                 : ${get('audio', 'Language_String3') || get('audio', 'Language')}`,
          ].join('\n').trim() + '\n';
        };

        const createPanel = () => {
          const root = document.createElement('section');
          root.className = 'api-panel';
          root.innerHTML = `
            <h3 style="margin:0 0 8px 0;">Mode API MediaInfo (Docker/NAS)</h3>
            <p style="margin:0 0 10px 0;color:#94a3b8;">Déposez une vidéo (.mkv, .mp4, .avi) pour obtenir MediaInfo JSON + NFO.</p>
            <div class="api-row">
              <input id="api-file-input" type="file" accept=".mkv,.mp4,.avi,video/*" />
              <button id="api-analyze-btn" class="api-btn" type="button">Analyser via /api/analyze</button>
              <button id="api-copy-nfo" class="api-btn" type="button">Copier NFO</button>
            </div>
            <div id="api-drop-zone" class="api-drop">Glissez-déposez un fichier vidéo ici</div>
            <div id="api-status" class="api-status"></div>
            <details style="margin-top:10px;">
              <summary>MediaInfo JSON</summary>
              <pre id="api-json" class="api-result"></pre>
            </details>
            <details style="margin-top:10px;" open>
              <summary>NFO généré</summary>
              <pre id="api-nfo" class="api-result"></pre>
            </details>
          `;
          return root;
        };

        const setStatus = (el, msg) => {
          if (el) el.textContent = msg;
        };

        const findNfoTextarea = () => {
          const textareas = [...document.querySelectorAll('textarea')];
          return textareas.find((ta) => {
            const ctx = `${ta.placeholder || ''} ${ta.id || ''} ${ta.name || ''}`.toLowerCase();
            return ctx.includes('nfo') || ctx.includes('coller');
          }) || null;
        };

        const injectNfoToApp = (nfoText) => {
          const target = findNfoTextarea();
          if (!target) return false;
          target.value = nfoText;
          target.dispatchEvent(new Event('input', { bubbles: true }));
          target.dispatchEvent(new Event('change', { bubbles: true }));
          return true;
        };

        const hideMediaInfoWarnings = () => {
          const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
          const bad = [];
          while (walker.nextNode()) {
            const value = String(walker.currentNode.nodeValue || '');
            if (value.toLowerCase().includes('module mediainfo') || value.toLowerCase().includes('mediainfo indisponible')) {
              bad.push(walker.currentNode.parentElement);
            }
          }
          bad.forEach((el) => {
            if (el) el.style.display = 'none';
          });
        };

        const analyzeFile = async (file, ui, origin = 'manual') => {
          if (!file) {
            setStatus(ui.status, 'Aucun fichier sélectionné.');
            return;
          }
          const extension = ext(file.name);
          if (!ALLOWED.includes(extension)) {
            setStatus(ui.status, `Extension non autorisée: ${extension || '(none)'}`);
            return;
          }

          const form = new FormData();
          form.append('file', file, file.name);

          setStatus(ui.status, `NAS mode: analyse en cours (${origin}) – ${file.name}`);
          ui.json.textContent = '';
          ui.nfo.textContent = '';

          try {
            const res = await fetch(API_ANALYZE_URL, { method: 'POST', body: form });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || `Erreur API (${res.status})`);

            const nfoText = data.nfo_text || buildMinimalNfo(data.media_info_json || {});
            ui.json.textContent = JSON.stringify(data.media_info_json || {}, null, 2);
            ui.nfo.textContent = nfoText;
            const injected = injectNfoToApp(nfoText);
            hideMediaInfoWarnings();
            setStatus(
              ui.status,
              `NAS mode actif: analyse OK (${Math.round((data.size_bytes || 0) / (1024 * 1024))} MB). ${injected ? 'NFO injecté dans l'app.' : 'Injection NFO impossible, utilisez le panneau.'}`
            );
          } catch (err) {
            setStatus(ui.status, `Erreur API: ${err.message}`);
          }
        };

        const setupCaptureInterceptors = (ui) => {
          const looksLikeVideoFile = (file) => !!file && ALLOWED.includes(ext(file.name || ''));

          document.addEventListener('change', (event) => {
            if (!nasModeEnabled) return;
            const input = event.target;
            if (!(input instanceof HTMLInputElement) || input.type !== 'file') return;
            const file = input.files && input.files[0];
            if (!looksLikeVideoFile(file)) return;
            event.stopImmediatePropagation();
            analyzeFile(file, ui, 'input-capture');
          }, true);

          ['drop', 'dragover', 'dragenter'].forEach((type) => {
            document.addEventListener(type, (event) => {
              if (!nasModeEnabled) return;
              const dt = event.dataTransfer;
              if (!dt || !dt.files || !dt.files[0] || !looksLikeVideoFile(dt.files[0])) return;
              event.preventDefault();
              if (type === 'drop') {
                event.stopImmediatePropagation();
                analyzeFile(dt.files[0], ui, 'drop-capture');
              }
            }, true);
          });
        };

        const checkApiHealth = async () => {
          try {
            const response = await fetch(API_HEALTH_URL, { cache: 'no-store' });
            if (!response.ok) return false;
            const payload = await response.json();
            return payload && payload.status === 'ok';
          } catch {
            return false;
          }
        };

        window.addEventListener('unhandledrejection', (event) => {
          if (!nasModeEnabled) return;
          const reasonText = String(event.reason && (event.reason.message || event.reason) || '').toLowerCase();
          if (reasonText.includes('mediainfo')) {
            event.preventDefault();
            hideMediaInfoWarnings();
          }
        });

        document.addEventListener('DOMContentLoaded', async () => {
          const appRoot = document.getElementById('app');
          if (!appRoot || document.getElementById('api-file-input')) return;

          const panel = createPanel();
          appRoot.insertAdjacentElement('afterend', panel);

          const input = document.getElementById('api-file-input');
          const button = document.getElementById('api-analyze-btn');
          const copyNfo = document.getElementById('api-copy-nfo');
          const dropZone = document.getElementById('api-drop-zone');
          const json = document.getElementById('api-json');
          const nfo = document.getElementById('api-nfo');
          const status = document.getElementById('api-status');

          const ui = { json, nfo, status };
          nasModeEnabled = await checkApiHealth();
          setStatus(status, nasModeEnabled ? `${__LC_NAS_MODE_SIGNATURE}: API disponible.` : 'Mode NAS inactif: /api/health indisponible (GH Pages = NFO only).');

          button.addEventListener('click', () => analyzeFile(input.files[0], ui, 'panel-button'));
          input.addEventListener('change', () => {
            if (input.files[0]) setStatus(status, `Fichier prêt: ${input.files[0].name}`);
          });
          copyNfo.addEventListener('click', async () => {
            if (!nfo.textContent) return;
            try {
              await navigator.clipboard.writeText(nfo.textContent);
              setStatus(status, 'NFO copié dans le presse-papiers.');
            } catch {
              setStatus(status, 'Impossible de copier automatiquement.');
            }
          });

          ['dragenter', 'dragover'].forEach((evt) => {
            dropZone.addEventListener(evt, (e) => {
              e.preventDefault();
              dropZone.style.borderColor = '#22c55e';
            });
          });
          ['dragleave', 'drop'].forEach((evt) => {
            dropZone.addEventListener(evt, (e) => {
              e.preventDefault();
              dropZone.style.borderColor = '#475569';
            });
          });
          dropZone.addEventListener('drop', (e) => {
            const file = e.dataTransfer?.files?.[0];
            if (!file) return;
            analyzeFile(file, ui, 'panel-drop');
          });

          setupCaptureInterceptors(ui);

          const observer = new MutationObserver(() => {
            if (nasModeEnabled) hideMediaInfoWarnings();
          });
          observer.observe(document.body, { subtree: true, childList: true, characterData: true });
        });
      })();
    </script>
    <script type="module" crossorigin src="assets/index-Ddv4Ao2m.js"></script>
    <link rel="stylesheet" crossorigin href="assets/index-BXI7GdG3.css">
  </head>
  <body>
    <div id="app"></div>
  </body>

<!-- Mirrored from upload-helper.n0flow.io/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 17 Feb 2026 10:08:26 GMT -->
</html>
